name: Ktlint

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check:
    name: Check Code Style
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Run ktlint check
        id: ktlint
        run: |
          ./gradlew ktlintCheck --continue > ktlint.log 2>&1 || echo "failed=true" >> $GITHUB_OUTPUT

      - name: Parse and comment violations
        if: steps.ktlint.outputs.failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('ktlint.log', 'utf8');
            
            // íŒŒì¼ë³„ë¡œ ì—ëŸ¬ íŒŒì‹±
            const violations = {};
            const lines = log.split('\n');
            
            for (const line of lines) {
              const match = line.match(/^(.+\.kt):(\d+):(\d+): (.+)$/);
              if (match) {
                const [, file, lineNum, col, message] = match;
                if (!violations[file]) violations[file] = [];
                violations[file].push({ line: lineNum, message });
              }
            }
            
            // PR ë¦¬ë·° ì½”ë©˜íŠ¸ ì‘ì„±
            const comments = [];
            for (const [file, issues] of Object.entries(violations)) {
              for (const issue of issues.slice(0, 10)) { // íŒŒì¼ë‹¹ ìµœëŒ€ 10ê°œ
                comments.push({
                  path: file,
                  line: parseInt(issue.line),
                  body: `**Ktlint**: ${issue.message}`
                });
              }
            }
            
            if (comments.length > 0) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'REQUEST_CHANGES',
                body: `## ğŸ” Ktlint ê²€ì‚¬ ê²°ê³¼\n\n${comments.length}ê°œì˜ ìŠ¤íƒ€ì¼ ì´ìŠˆë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.\n\nì•„ë˜ ëª…ë ¹ì–´ë¡œ ìë™ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\`\`\`bash\n./gradlew ktlintFormat\n\`\`\``,
                comments: comments.slice(0, 50) // GitHub API ì œí•œ
              });
            }

      - name: Fail if violations found
        if: steps.ktlint.outputs.failed == 'true'
        run: exit 1

  # ì„ íƒì : auto-fix ë²„íŠ¼
  fix:
    name: Auto-fix (Manual Trigger)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run ktlint format
        run: ./gradlew ktlintFormat

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: apply ktlint auto-fixes"